{% extends "@App/Event/layout_cboxed.html.twig" %}

{# Données d'entrée :
- event (Event) L'évenement à afficher
- eventForm (Form|null) Formulaire d'édition des information général de l'événement (si les droits le permettent)
- invitationsForm (Form|null) Formulaire permettant d'inviter (renseignement des e-mails des invités)
- modules (array) Tableau des modules de l'événement. Chaque module est décrit un tableau de données (Cf. EventManager:getModulesToDisplay(...) )
- userEventInvitation (EventInvitation) L'invitation à afficher
- userEventInvitationForm (Form) Formulaire de réponse à l'invitation : données de profil
- userEventInvitationAnswerForm (Form) Formulaire de réponse à l'invitation
#}


{% block mainMenu_listItems %}
    <li><a href="#event-header-card">{{ "global.event"|trans|capitalize }}</a></li>
    {% for moduleDescription in modules if moduleDescription.module.name is not empty and moduleDescription.module.status != constant("AppBundle\\Utils\\enum\\ModuleStatus::DELETED") %}
        <li><a href="#module-{{ moduleDescription.module.token }}">{{ moduleDescription.module.name|capitalize }}</a></li>
    {% endfor %}
{% endblock mainMenu_listItems %}

{% block event_content %}
    {% if is_granted(constant('AppBundle\\Security\\EventVoter::ADD_EVENT_MODULE'), userEventInvitation) %}
        {# TODO Positionner le menu s'ouvrant relativement au browser #}
        <div class="dropup add-module-menu">
            <button class="btn btn-float btn-danger m-btn waves-effect waves-circle waves-float" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="zmdi zmdi-plus"></i>
            </button>

            {#<a data-toggle="dropdown" href="#" class="btn btn-float palette-Teal bg waves-effect waves-circle waves-float"><i class="zmdi zmdi-plus"></i></a>#}
            <ul class="dropdown-menu dropdown-menu-right">
                <li>
                    <a class="add-pollmodule-link" href="{{ url('addEventModule', {'token': event.token, 'type':constant('AppBundle\\Utils\\enum\\ModuleType::POLL_MODULE'),
                        'subtype':constant('AppBundle\\Utils\\enum\\PollModuleType::WHAT')}) }}" id="addWhatPollModule">
                        <small>{{ "pollmodule.add_link.what"|trans }}</small>
                        <i class="waves-effect palette-Deep-Orange bg zmdi zmdi-pin-help"></i> </a>
                </li>
                <li>
                    <a class="add-pollmodule-link" href="{{ url('addEventModule', {'token': event.token,'type':constant('AppBundle\\Utils\\enum\\ModuleType::POLL_MODULE'),
                        'subtype':constant('AppBundle\\Utils\\enum\\PollModuleType::WHEN')}) }}" id="addWhenPollModule">
                        <small>{{ "pollmodule.add_link.when"|trans }}</small>
                        <i class="waves-effect palette-Blue bg zmdi zmdi-calendar"></i> </a>
                </li>
                {#<li>
                    <a data-toggle="modal" href="#"><i class="waves-effect palette-Teal bg zmdi zmdi-map"></i>
                        <small>Sondage Où ?</small>
                    </a>
                </li>
                <li>
                    <a data-toggle="modal" href="#"> <i class="waves-effect palette-Yellow-900 bg zmdi zmdi-money-box"></i>
                        <small>Cagnotte</small>
                    </a>
                </li>
                <li>
                    <a data-toggle="modal" href="#"><i class="waves-effect palette-Green bg zmdi zmdi-format-list-bulleted"></i>
                        <small>Qui apporte quoi ?</small>
                    </a>
                </li>
                <li>
                    <a data-toggle="modal" href="#"> <i class="waves-effect palette-Purple bg zmdi zmdi-balance-wallet"></i>
                        <small>Comptes entre amis</small>
                    </a>
                </li>#}
            </ul>
        </div>
        <script>
            $('.add-pollmodule-link').on('click', function (e) {
                ajaxRequest(this, null, e, function (responseJSON, textStatus, jqXHR) {
                    var eventModulesContainer = $('#eventModulesContainer');
                    $('.grid').masonry('layout');
                    $(document).scrollTop($(eventModulesContainer).children().last().offset().top);
                }, null, null);
            });
        </script>
    {% endif %}

    <div class="grid row">
        <!-- .grid-sizer empty element, only used for element sizing -->
        <div class="grid-sizer col-xs-12 col-lg-4"></div>

        <div class="grid-item col-xs-12 col-lg-8">
            {{ include("@App/Event/partials/event_header_card.html.twig", {'userEventInvitation':userEventInvitation, 'eventForm':eventForm}) }}
        </div>

        <div class="grid-item col-xs-12 col-lg-4">
            <div class="row">
                <div class="col-xs-12 col-md-6 col-lg-12">
                    {{ include("@App/Event/partials/eventInvitation_profile_card.html.twig", {
                        "userEventInvitation":userEventInvitation,
                        'userEventInvitationForm' : userEventInvitationForm}) }}
                </div>
                <div class="col-xs-12 col-md-6 col-lg-12">
                    {{ include("@App/Event/partials/eventInvitation_answerCard.html.twig", {'userEventInvitation':userEventInvitation,'userEventInvitationAnswerForm':userEventInvitationAnswerForm}) }}
                </div>

                <div class="col-xs-12">
                    {{ include('@App/Event/partials/eventInvitations_card.html.twig', {
                        'userEventInvitation':userEventInvitation,
                        'eventInvitations':event.eventInvitations,
                        'invitationsForm':invitationsForm
                    }) }}
                </div>
            </div>
        </div>

        <div class="grid-item col-xs-12 col-lg-8" id="eventModulesContainer">
            {% for moduleDescription in modules if moduleDescription.module.status != constant("AppBundle\\Utils\\enum\\ModuleStatus::DELETED") %}
                {% set userModuleInvitation = userEventInvitation.getModuleInvitationForModule(moduleDescription.module) %}
                {% if userModuleInvitation != null %}
                    {% if moduleDescription.module.pollModule is not null %}
                        {{ include('@App/Event/module/displayPollModule.html.twig', {
                            'module':moduleDescription.module,
                            'moduleForm':(moduleDescription.moduleForm is defined?moduleDescription.moduleForm:null),
                            'userModuleInvitation':userModuleInvitation,
                            'pollProposalAddForm':(moduleDescription.pollProposalAddForm is defined?moduleDescription.pollProposalAddForm:null )
                        }) }}
                    {% elseif moduleDescription.module.expenseModule is not null %}
                        {{ include('@App/Event/module/displayExpenseModule.html.twig', {
                            'module':moduleDescription.module,
                            'moduleForm':(moduleDescription.moduleForm is defined?moduleDescription.moduleForm:null),
                            'userModuleInvitation':userModuleInvitation
                        }) }}
                    {% else %}
                        {{ include('@App/Event/module/displayModule.html.twig', {
                            'module':moduleDescription.module,
                            'moduleForm':(moduleDescription.moduleForm is defined?moduleDescription.moduleForm:null),
                            'userModuleInvitation':userModuleInvitation
                        }) }}
                    {% endif %}
                {% endif %}
            {% endfor %}
        </div>

    </div>
{% endblock event_content %}

{% block stylesheets %}
    {{ parent() }}
    {# Necessaire ? <link rel="stylesheet" href="{{ asset("bundles/app/css/selectize.css") }}">#}
    <link rel="stylesheet" href="{{ asset("bundles/app/css/selectize.bootstrap3.css") }}">
    <link rel="stylesheet" href="{{ asset("bundles/app/css/selectize.at.css") }}">
    <link rel="stylesheet" href="{{ asset("bundles/app/css/fileinput.min.css") }}">
{% endblock stylesheets %}

{% block top_javascripts %}
    {{ parent() }}
    <script src="{{ asset("bundles/app/js/jquery.collection.js") }}"></script>
    <script src="{{ asset("bundles/app/js/selectize-standalone.min.js") }}"></script>
    <script src="{{ asset("bundles/app/js/at-selectize.js") }}"></script>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset("bundles/app/js/masonry.pkgd.min.js") }}"></script>

    <!-- canvas-to-blob.min.js is only needed if you wish to resize images before upload.
     This must be loaded before fileinput.min.js -->
    <script src="{{ asset("bundles/app/js/fileinput_dep/canvas-to-blob.min.js") }}" type="text/javascript"></script>
    <!-- sortable.min.js is only needed if you wish to sort / rearrange files in initial preview.
         This must be loaded before fileinput.min.js -->
    <script src="{{ asset("bundles/app/js/fileinput_dep/sortable.min.js") }}" type="text/javascript"></script>
    <!-- purify.min.js is only needed if you wish to purify HTML content in your preview for HTML files.
         This must be loaded before fileinput.min.js -->
    <script src="{{ asset("bundles/app/js/fileinput_dep/purify.min.js") }}" type="text/javascript"></script>
    <!-- the main fileinput plugin file -->
    <script src="{{ asset('bundles/app/js/fileinput.js') }}"></script>
    <!-- optionally if you need a theme like "Material Design" theme  -->
    <script src="{{ asset('bundles/app/js/fileinput_dep/theme_zmdi.js') }}"></script>
    {% if app.request.attributes.get('_locale') == 'fr' %}
        <!-- optionally if you need translation for your language -->
        <script src="{{ asset('bundles/app/js/fileinput_dep/fr.js') }}"></script>
    {% endif %}

    {# Plugin for cliplboard field (copy into clipboard by clicking) #}
    <script src="{{ asset('bundles/app/js/clipboard.min.js') }}"></script>

    <script src="{{ asset("bundles/app/js/at-event.js") }}"></script>

    {% if userEventInvitation is defined and userEventInvitation.status is constant('AppBundle\\Utils\\enum\\EventInvitationStatus::AWAITING_VALIDATION') %}
        <script>
            swal({
                title: "{{ "eventInvitation.profile.card.new_warning_alert.title"|trans|raw }}",
                text: "{{ "eventInvitation.profile.card.new_warning_alert.message"|trans|raw }}",
                type: "input",
                showCancelButton: false,
                closeOnConfirm: false,
                animation: "slide-from-top",
                inputPlaceholder: "{{ "eventInvitation.form.guestname.placeholder"|trans|raw }}"
            }, function (inputValue) {
                if (inputValue === false) return false;
                if (inputValue === "") {
                    swal.showInputError("{{ "eventInvitation.profile.card.new_warning_alert.inputError"|trans|raw }}");
                    return false
                }
                $('#event_invitation_guestName').val(inputValue);
                $('form#userEventInvitationProfile').submit();
                swal.close();
            });
        </script>
    {% endif %}

{% endblock %}