{# Données d'entrée :
- pollProposal (PollProposal) La proposition à afficher
- moduleInvitations ([ModuleInvitaion]) les invitations du module
#}

{% set numberOfResponse = 0 %}
{% set totalOfResponse = 0 %}
<div class="modal fade in" id="modalPollProposal{{ pollProposal.id }}" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><i class="zmdi zmdi-close"></i></span></button>
                {% for ppElt in pollProposal.pollProposalElements if ppElt.pollElement.type !=constant('AppBundle\\Utils\\enum\\PollElementType::PICTURE') %}
                    {% if not loop.first %}<br>{% endif %}
                    {% if ppElt.pollElement.type == constant('AppBundle\\Utils\\enum\\PollElementType::DATETIME') %}
                        {% set endDate = ppElt.pollProposal.getPollProposalEndDateElement %}
                        {% set has2Date = endDate is not null and endDate.hasEndDate and ppElt.value|localizeddate("medium", "none", null, null,'ddMMyyyy') != endDate.value|localizeddate("medium", "none", null, null,'ddMMyyyy') %}
                        <div>
                            {% if not has2Date %}
                                <div style="display:inline-block; vertical-align: middle;">
                                    <div style="font-size:12px; font-weight: bold; text-transform: capitalize;">{{ ppElt.value|localizeddate("medium", "none", null, null,'MMM') }}</div>
                                    <div style="font-size:10px; text-transform: uppercase;">{{ ppElt.value|localizeddate("medium", "none", null, null,"ccc") }}</div>
                                </div>
                                <div class="p-l-5 p-r-5" style="display:inline-block; font-size:22px; vertical-align: middle;">
                                    <strong>{{ ppElt.value|localizeddate("medium", "none", null, null,'dd') }}</strong>
                                </div>
                                {% if ppElt.hasTime %}
                                    <div style="display:inline-block; vertical-align: middle;">
                                        <div style="font-size:14px">{{ ppElt.value|localizeddate("medium", "none", null, null,'HH:mm') }}</div>
                                        {% if not has2Date and endDate is not null and endDate.hasEndTime %}
                                            <div style="font-size:14px">{{ endDate.value|localizeddate("medium", "none", null, null,'HH:mm') }}</div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div>
                                    <div style=" display:inline-block; width: 45px; font-style:italic">Début :</div>
                                    <div style=" display:inline-block;">{{ ppElt.value|localizeddate("medium", "none", null, null,'ccc dd MMM') }}{% if ppElt.hasTime %} {{ ppElt.value|localizeddate("medium", "none", null, null,'HH:mm') }}{% endif %}</div>
                                </div>
                                <div>
                                    <div style=" display:inline-block; width:45px; font-style:italic">Fin :</div>
                                    <div style=" display:inline-block;">{{ endDate.value|localizeddate("medium", "none", null, null,'ccc dd MMM') }}{% if endDate.hasEndTime %} {{ endDate.value|localizeddate("medium", "none", null, null,'HH:mm') }}{% endif %}</div>
                                </div>
                            {% endif %}
                        </div>
                    {% elseif not (ppElt.pollElement.type == constant('AppBundle\\Utils\\enum\\PollElementType::END_DATETIME')) %}
                        {% if ppElt.pollElement.type==constant('AppBundle\\Utils\\enum\\PollElementType::RICHTEXT') %}
                            {{ ppElt.value|raw }}
                        {% else %}
                            <h4 class="modal-title">{{ ppElt.value }}</h4>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
            <div class="modal-body">
                <table class="table table-striped table-condensed">
                    <tbody>
                    {# Pour chaque réponse d'une proposition #}
                    {% for moduleInvitation in moduleInvitations %}
                        {% set guestPollProposalResponse = pollProposal.pollProposalResponsesOfModuleInvitation(moduleInvitation) %}
                        {% if guestPollProposalResponse is not null %}
                            {% set response = guestPollProposalResponse is null or guestPollProposalResponse.answer is null?0:guestPollProposalResponse.answer %}
                            {% if response > 0 %}
                                {% set totalOfResponse = totalOfResponse + response %}
                                {% set numberOfResponse = numberOfResponse + 1 %}
                                <tr>
                                    <td>
                                        <div class="avatar-img-container-sm center-block m-b-5">
                                            {{ include("@App/Avatar/partials/avatar_display.html.twig",{invitation : moduleInvitation}) }}
                                        </div>
                                    </td>
                                    <td>
                                        {{ moduleInvitation.displayableName(true, true) }}
                                    </td>
                                    <td>
                                        <span class="answer-thumb palette-Yellow-100 bg c-amber strong">
                                                {{ response }} <i class="zmdi zmdi-star"></i>
                                        </span>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    </tbody>
                </table>
                <div class=" w-100">
                    <h3>{{ "pollmodule.display.result.moyenne"|trans }}&#8239;{{ totalOfResponse }}</h3>
                </div>
            </div>
        </div>
    </div>
</div>
{% set average = numberOfResponse > 0 ? (totalOfResponse/numberOfResponse) | number_format(1) : 0 %}
{% if totalOfResponse > 0 %}
    <a data-toggle="modal" href="#modalPollProposal{{ pollProposal.id }}" class="">
        <span>
        {% for i in 1..5 %}
            {% if average - i >= 0 %}
                <i class="zmdi zmdi-star c-amber"></i>
            {% elseif average - i >= -0.5 %}
                <i class="zmdi zmdi-star-half c-amber"></i>
            {% else %}
                <i class="zmdi zmdi-star c-bluegray"></i>
            {% endif %}
        {% endfor %}
        </span>
        {{ "pollmodule.display.result.moyenne"|trans }}&#8239;{{ average }}
        {# A voir si on garde le nombre de contribuions #}
        {#{{ numberOfResponse }}&#8239;{{ "pollmodule.display.result.contribution"|trans }}#}
    </a>
{% else %}
    <span>
        {% for i in 1..5 %}
            {% if average - i >= 0 %}
                <i class="zmdi zmdi-star c-amber"></i>
            {% elseif average - i >= -0.5 %}
                <i class="zmdi zmdi-star-half c-amber"></i>
            {% else %}
                <i class="zmdi zmdi-star c-bluegray"></i>
            {% endif %}
        {% endfor %}
        </span>
    {{ "pollmodule.display.result.moyenne"|trans }}&#8239;{{ average }}
    {#{{ numberOfResponse }}&#8239;{{ "pollmodule.display.result.contribution"|trans }}#}
{% endif %}