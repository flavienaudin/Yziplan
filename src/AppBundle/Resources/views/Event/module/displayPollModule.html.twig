{% extends "@App/Event/module/displayModule.html.twig" %}

{# Données d'entrée :
- module (Module) Le module à afficher
- moduleForm (Form|null) Le formulaire d'édition du module
- userModuleInvitation (ModuleInvitation) L'invitation du module de l'utilisateur connecté
- pollProposalAddForm (Form|null) Le formulaire d'ajout d'une proposition
#}


{% set maxColModule = constant("AppBundle\\Manager\\ModuleInvitationManager::MAX_COLUMN_DISPLAYABLE") %}
{% set add_pp_form_modal_prefix = 'add_pp_fm_'~module.token %}

{% block moduleCardClass %}{{ parent() }}{% endblock moduleCardClass %}
{% block moduleHeaderClass %}{{ parent() }}{% endblock moduleHeaderClass %}
{% block moduleHeaderAttributs %}{{ parent() }}{% endblock moduleHeaderAttributs %}

{% block mhBtnFloat %}{% endblock mhBtnFloat %}

{% block moduleBodyClass %}card-padding-sm{% endblock %}
{#{% block moduleBodyAttributs %}{% endblock %}#}
{% block moduleBody %}
    {{ parent() }}
    {% if module.pollModule is not null %}
        {% set proposalList = module.pollModule.getValidPollProposal %}
            <div class="w-100 poll-container">
                <table id="pollmodule-table-{{ module.token }}" class="table-striped w-100">
                    {#                <thead>
                                    <tr>
                                        <td>Description</td>
                                        <td class="response-column">Résultats</td>
                                        <td class="voting-column">Réponse</td>
                                    </tr>
                                    </thead>#}
                    <tbody id="pp-row-group-{{ module.token }}">
                    {# Pour chaque proposition #}
                    {% for pollProposal in module.pollModule.pollProposals if not pollProposal.deleted and pollProposal.id is not null %}
                        {{ include('@App/Event/module/pollModulePartials/pollProposalGuestResponseRowDisplay.html.twig', {
                            "pollProposal":pollProposal,
                            "userModuleInvitation":userModuleInvitation,
                            "moduleInvitations":module.moduleInvitations
                        }) }}
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="text-center m-20">
                {# Conteneur pour la modale ajouté via ajax #}
                <div id="pollModuleDisplayAllResult_{{ module.token }}_container"></div>

                <a id="pollModuleDisplayAllResult_{{ module.token }}_button" role="button" href="{{ path('pollModuleDisplayResultTable', {"moduleToken": module.token }) }}"
                   class="btn btn-default waves-effect" {% if proposalList is empty %}style="display: none;"{% endif %}>{{ "pollmodule.display.result.allresult"|trans }}</a>

                <script>
                    $('#pollModuleDisplayAllResult_{{ module.token }}_button').on('click', function (e) {
                        ajaxRequest($(this), null, e, function (responseJSON, textStatus, jqXHR) {
                            LetterAvatar.transform();
                            $('#pollModuleDisplayAllResult_{{ module.token }}_modale').modal('show');
                        }, null, null);
                    });
                </script>
            </div>
        {% if proposalList is empty %}
            <div id="pollmodule-nopropal_{{ module.token }}" class="pollmodule-nopropal">
                {{ "pollmodule.display.no_proposal"|trans }}
                <script>
                    $('#pollmodule-table-{{ module.token }}').bind("DOMSubtreeModified", function(e){
                        $("#pollmodule-nopropal_{{ module.token }}").hide();
                        $("#pollModuleDisplayAllResult_{{ module.token }}_button").show();
                    })
                </script>
            </div>
        {% endif %}
        {% if pollProposalAddForm is defined and pollProposalAddForm is not null %}
            {{ include('@App/Event/module/pollModulePartials/pollProposal_form_min.html.twig', {
                'userModuleInvitation' : userModuleInvitation,
                'pollProposalForm' : pollProposalAddForm,
                'pp_form_modal_prefix' : add_pp_form_modal_prefix
            }) }}
        {% endif %}
    {% endif %}
{% endblock moduleBody %}

{#{% block moduleFooter %}{% endblock moduleFooter %}#}

{% block module_modal_container %}{% endblock module_modal_container %}
